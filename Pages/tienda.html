<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Compras | NovaTech</title>
    <link rel="icon" href="/Img/Logo.webp">
    <link rel="stylesheet" href="/Css/root.css" />
    <link rel="stylesheet" href="/Css/tienda.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="/Js/include.js"></script>
    <script src="/Js/script.js" defer></script>
</head>

<body>
    <header></header>


    <div class="container">

        <!-- Barra de filtros -->
        <aside class="filters">
            <h2>Filtros</h2>

            <!-- Filtro por categorÃ­a -->
            <div class="section">
                <label>CategorÃ­as</label>
                <div id="categoryFilters">
                </div>
            </div>

            <!-- Rango de precio -->
            <div class="section">
                <label>Rango de precio</label>
                <div class="price-range">
                    <span id="priceValue">$0 - $1000</span>
                    <input type="range" min="0" max="1000" step="10" value="1000" id="priceRange">
                </div>
            </div>

        </aside>

        <!-- CatÃ¡logo -->
        <main class="catalogo">

            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="Buscar productos">
                <i class="fa-solid fa-magnifying-glass"></i>
                <i class="fa-solid fa-cart-shopping cart-icon" id="openCart"></i>
                <span id="cartCount" class="cart-count">0</span>

            </div>

            <!-- Popup de producto aÃ±adido -->
            <div id="productAddedPopup" class="popup-added">
                <i class="fa-solid fa-check"></i> Producto aÃ±adido al carrito
            </div>

            <!-- Panel lateral PREMIUM -->
            <div id="sideCart" class="side-cart">
                <button id="closeCart" class="close-cart-btn">Ã—</button>
                <h2>Tu Carrito</h2>

                <div id="cartItems" class="side-items"></div>

                <div class="side-footer">
                    <p class="total-label">Total:</p>
                    <p class="total-value">$<span id="cartTotal">0</span></p>

                    <button id="goToCart" class="btn-secondary">Ver carrito</button>
                    <button id="finishPurchase" class="btn-primary">Finalizar compra</button>
                </div>
            </div>

            <!-- POPUP de confirmaciÃ³n de compra -->
            <div id="confirmPopup" class="confirm-popup">
                <div class="popup-content">
                    <h3>Â¡Compra realizada! ðŸŽ‰</h3>
                    <p>Tu pedido ha sido confirmado con Ã©xito.</p>
                    <button id="closePopup" class="btn-primary">Cerrar</button>
                </div>
            </div>

            <!-- aqui es donde se cargan los productos -->
            <div class="grid" id="productGrid"></div>

        </main>

    </div>

    <footer></footer>

    <script>
        // Variables
        let productos = [];
        let carrito = JSON.parse(localStorage.getItem("carrito")) || [];

        // Cargar productos
        async function cargarProductos() {
            try {
                const res = await fetch("https://fakestoreapi.com/products");
                productos = await res.json();
                mostrarProductos(productos);
                cargarCategorias();
                renderSideCart(); // AHORA sÃ­ es vÃ¡lido
            } catch (e) {
                console.error("Error cargando productos:", e);
            }
        }

        // Mostrar productos
        function mostrarProductos(lista) {
            const grid = document.getElementById("productGrid");
            grid.innerHTML = "";

            lista.forEach(prod => {
                grid.innerHTML += `
                <div class="item">
                    <img src="${prod.image}" alt="${prod.title}" onclick="verProducto(${prod.id})">
                    <h4 onclick="verProducto(${prod.id})">${prod.title}</h4>
                    <p>${prod.category}</p>
                    <p>$${prod.price}</p>
                    <button class="add-btn" data-id="${prod.id}" onclick="agregarCarrito(${prod.id}, this)">AÃ±adir</button>
                </div>`;
            });
        }


        // Filtros y categorÃ­as
        async function cargarCategorias() {
            const res = await fetch("https://fakestoreapi.com/products/categories");
            const categorias = await res.json();

            const cont = document.getElementById("categoryFilters");

            categorias.forEach(cat => {
                const id = cat.replace(/\s+/g, "-");

                cont.innerHTML += `
                <div>
                    <input type="checkbox" class="catFilter" id="${id}" value="${cat}" checked>
                    <label for="${id}">${cat}</label>
                </div>`;
            });

            document.querySelectorAll(".catFilter").forEach(cb =>
                cb.addEventListener("change", aplicarFiltros)
            );
        }

        function aplicarFiltros() {
            const texto = document.getElementById("searchInput").value.toLowerCase();
            const precioMax = parseFloat(document.getElementById("priceRange").value);

            const categoriasSeleccionadas = [...document.querySelectorAll(".catFilter:checked")].map(c => c.value);

            const filtrados = productos.filter(p =>
                p.title.toLowerCase().includes(texto) &&
                p.price <= precioMax &&
                categoriasSeleccionadas.includes(p.category)
            );

            mostrarProductos(filtrados);
        }

        // Agregar al carrito
        function agregarCarrito(id, btnEl) {
            let cantidadUI = 1;
            const qtySpan = document.getElementById(`qty-${id}`);
            if (qtySpan) {
                const parsed = parseInt(qtySpan.textContent);
                if (!isNaN(parsed) && parsed > 0) cantidadUI = parsed;
            }

            const prod = productos.find(p => p.id === id);
            if (!prod) return;

            const existe = carrito.find(p => p.id === id);

            if (existe) {
                existe.cantidad += cantidadUI;
            } else {
                carrito.push({ ...prod, cantidad: cantidadUI });
            }

            // Guardar
            localStorage.setItem("carrito", JSON.stringify(carrito));

            showAddedPopup();
            updateCartCounter();
            shakeCartIcon();
            renderSideCart();

            if (btnEl) {
                const originalText = btnEl.innerHTML;
                btnEl.innerHTML = "Producto aÃ±adido";
                btnEl.classList.add("added");
                setTimeout(() => {
                    btnEl.classList.remove("added");
                    btnEl.innerHTML = originalText;
                }, 1200);
            }
        }

        // Contador
        function updateCartCounter() {
            const count = document.getElementById("cartCount");
            const totalItems = carrito.reduce((acc, p) => acc + p.cantidad, 0);

            count.textContent = totalItems;
            count.classList.add("bump");
            setTimeout(() => count.classList.remove("bump"), 200);
        }

        // Panel del carrito
        function renderSideCart() {
            const container = document.getElementById("cartItems");
            let total = 0;

            container.innerHTML = "";

            if (carrito.length === 0) {
                container.innerHTML = "<p style='opacity:0.7'>El carrito estÃ¡ vacÃ­o</p>";
                document.getElementById("cartTotal").innerText = "0";
                return;
            }

            carrito.forEach(item => {
                total += item.price * item.cantidad;

                container.innerHTML += `
                <div class="side-item">
                    <img src="${item.image}">
                    <div class="side-info">
                        <h4>${item.title}</h4>
                        <p>$${item.price}</p>
                    </div>

                    <div class="side-actions">
                        <div class="qty-control">
                            <button onclick="cambiarCantidad(${item.id}, -1)">âˆ’</button>
                            <span>${item.cantidad}</span>
                            <button onclick="cambiarCantidad(${item.id}, 1)">+</button>
                        </div>
                        <button class="delete-btn" onclick="eliminarProducto(${item.id})">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                </div>`;
            });

            document.getElementById("cartTotal").innerText = total.toFixed(2);
        }

        function showAddedPopup() {
            const popup = document.getElementById("productAddedPopup");
            popup.classList.add("show");

            setTimeout(() => {
                popup.classList.remove("show");
            }, 1500);
        }

        document.getElementById("closeCart").addEventListener("click", () => {
            document.getElementById("sideCart").classList.remove("open");
        });


        function shakeCartIcon() {
            const cart = document.getElementById("openCart");
            cart.classList.add("shake");

            setTimeout(() => {
                cart.classList.remove("shake");
            }, 600);
        }


        // Control cantidades lateral
        function cambiarCantidad(id, cambio) {
            const item = carrito.find(p => p.id === id);
            if (!item) return;

            item.cantidad += cambio;

            if (item.cantidad <= 0) {
                carrito = carrito.filter(p => p.id !== id);
            }

            localStorage.setItem("carrito", JSON.stringify(carrito));

            renderSideCart();
            updateCartCounter();
        }

        function eliminarProducto(id) {
            carrito = carrito.filter(item => item.id !== id);
            localStorage.setItem("carrito", JSON.stringify(carrito));

            renderSideCart();
            updateCartCounter();
        }

        // Pop up
        document.getElementById("finishPurchase").addEventListener("click", () => {
            document.getElementById("confirmPopup").classList.add("show");
            carrito = [];
            localStorage.removeItem("carrito");
            renderSideCart();
            updateCartCounter();
        });


        // Panel del carrito
        document.getElementById("openCart").addEventListener("click", () => {
            document.getElementById("sideCart").classList.toggle("open");
        });
        document.getElementById("goToCart").addEventListener("click", () => {
            window.location.href = "/Pages/carrito.html";


        });
        document.getElementById("closePopup").addEventListener("click", () => {
            document.getElementById("confirmPopup").classList.remove("show");
        });
        // Ver producto
        function verProducto(id) {
            window.location.href = `product.html?id=${id}`;
        }

        cargarProductos();
        updateCartCounter();

    </script>
</body>

</html>